#!/bin/bash
set -eu

# ----------------------------------------------------------------------------
# Get from version control FPC, Lazarus and build + install them system-wide.
#
# In a way, this is a "simple version of fpcup / fpcupdeluxe".
# This strives to be a simplest command-line script that gets FPC and Lazarus
# from version control and installs.
#
# Note: This assumes that FPC version suitable for "boostrapping" the indicated
# version (in FPC_BRANCHTAG) is already installed and on $PATH.
# E.g. you can do "apt install fpc" if your OS ships with proper FPC version
# (equal or one before FPC_BRANCHTAG).
# There is no need for Lazarus for bootstrapping.

# ----------------------------------------------------------------------------
# Configure these variables freely

# See https://gitlab.com/freepascal.org/fpc/source/-/tags for posibilities
FPC_BRANCHTAG='release_3_2_2'
# See https://gitlab.com/freepascal.org/lazarus/lazarus/-/tags for posibilities
LAZARUS_BRANCHTAG='lazarus_2_2_2'

# Must match FPC version in install directory.
# Also used to name src/install subdirectories of FPC.
FPC_VERSION='3.2.2'
# Used to name src/install subdirectories of Lazarus.
LAZARUS_VERSION='2.2.2'

# FPC and Lazarus sources and installed files will be under this.
BASE_DIR="$HOME/fpc_lazarus/"

# ppc binary suffix corresponding to current system architecture. Like arm, x64, x86.
PPC_SUFFIX='x64'
#PPC_SUFFIX='arm'

FPC_INSTALL="$BASE_DIR/installed/fpc/$FPC_VERSION"
LAZARUS_INSTALL="$BASE_DIR/installed/lazarus/$LAZARUS_VERSION"
FPC_SRC_PARENT="$BASE_DIR/src/fpc"
LAZARUS_SRC_PARENT="$BASE_DIR/src/lazarus"
FPC_SRC="$FPC_SRC_PARENT/$FPC_VERSION"
LAZARUS_SRC="$LAZARUS_SRC_PARENT/$LAZARUS_VERSION"

# ----------------------------------------------------------------------------
# End of configurable section.

export PATH="${FPC_INSTALL}/bin:${LAZARUS_INSTALL}:${PATH}"

do_cleanup ()
{
  rm -Rf "$FPC_INSTALL" "$LAZARUS_INSTALL"
}

do_get_fpc_lazarus ()
{
  rm -Rf "$FPC_SRC" "$LAZARUS_SRC"
  mkdir -p "$FPC_SRC_PARENT" "$LAZARUS_SRC_PARENT"

  cd "$FPC_SRC_PARENT"
  git clone https://gitlab.com/freepascal.org/fpc/source.git --depth 1 \
    --single-branch --branch "${FPC_BRANCHTAG}" "${FPC_VERSION}"

  cd "$LAZARUS_SRC_PARENT"
  git clone https://gitlab.com/freepascal.org/lazarus/lazarus.git --depth 1 \
    --single-branch --branch "${LAZARUS_BRANCHTAG}" "${LAZARUS_VERSION}"
}

do_install_fpc ()
{
  cd "$FPC_SRC"

  mkdir -p "${FPC_INSTALL}"
  make clean all install INSTALL_PREFIX="${FPC_INSTALL}"
  cd "${FPC_INSTALL}"/bin
  ln -s ../lib/fpc/"${FPC_VERSION}"/ppc"$PPC_SUFFIX" .

  # make symlinks, useful e.g. by /etc/fpc.cfg or ~/.fpc.cfg, and FPCDIR in /home/jenkins/.bashrc
  rm -f "${FPC_INSTALL}"/lib/fpc/current/
  ln -s "${FPC_VERSION}" "${FPC_INSTALL}"/lib/fpc/current
}

do_test_fpc ()
{
  cd /tmp/
  # test new fpc
  echo 'begin writeln(2+2) end.' > a.pas
  fpc -l
  fpc a.pas
  ./a
}

do_install_lazarus ()
{
  cd "$LAZARUS_SRC"
  mkdir -p "${LAZARUS_INSTALL}"
  make clean all install INSTALL_PREFIX="${LAZARUS_INSTALL}"

  # fix lazbuild to work, by passing --lazarusdir
  mv "${LAZARUS_INSTALL}lazbuild" "${LAZARUS_INSTALL}lazbuild-real"
  cat > "${LAZARUS_INSTALL}lazbuild" <<EOF
#!/bin/bash
set -eu

# DO NOT EDIT - this file is auto-generated and may be overridden.
# Created by CGE FPC/Lazarus compilation script.

${LAZARUS_INSTALL}lazbuild-real --lazarusdir=${LAZARUS_SRC} "\$@"
EOF
  chmod +x "${LAZARUS_INSTALL}lazbuild"
}

do_test_lazarus ()
{
  lazbuild --version
}

do_cleanup
do_get_fpc_lazarus
do_install_fpc
do_test_fpc
do_install_lazarus
do_test_lazarus
